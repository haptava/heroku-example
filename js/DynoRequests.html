<!DOCTYPE html>
<html>
<head lang="en">
  <meta charset="UTF-8">

  <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
  <title>Dyno Request Rate</title>

  <script type='text/javascript' src='http://ajax.googleapis.com/ajax/libs/jquery/1.8.2/jquery.min.js'></script>
  <script type='text/javascript' src='http://code.highcharts.com/highcharts.js'></script>
  <script type='text/javascript'>

    var src = 'https://api.haptava.io/public/versly/queries/7811800f-e892-4de9-9204-71053ff2a06f';
    var chart;

    function queryData() {
      $.ajax({
        url: src,
        success: function (json) {

          var reload = false;

          if (json.length != 1) {
            alert("JSON: " + json);
            alert("Error with query: length != 1");
          }
          else {
            if (json[0].series == undefined) {
              alert("Error with query: series missing");
            }
            else {
              if (chart.series.length != json[0].series.length) {
                reload = true;
              }
              else {
                for (i = 0; i < chart.series.length; i++) {
                  if (chart.series[i].name != json[0].series[i].name) {
                    reload = true;
                    break;
                  }
                }
              }

              if (reload) {
                location.reload();
              }
              else {
                for (i = 0; i < chart.series.length; i++) {
                  var newData = json[0].series[i].data;
                  chart.series[i].setData(newData);
                }
              }
            }
          }

          // call it again after a pause
          setTimeout(queryData, 3000);
        },
        cache: false
      });
    }

    $(document).ready(function () {
      var options = {
        chart: {
          type: 'bar',
          renderTo: 'container',
          events: {
            load: queryData
          }
        },
        title: {
          text: ''
        },
        subtitle: {
          text: ''
        },
        xAxis: {
          min: 0,
          crosshair: true,
          title: {
            text: ''
          },
          categories: []
        },
        yAxis: {
          min: 0,
          max: 10,
          title: {
            text: ''
          }
        },
        tooltip: {
          headerFormat: '<span style="font-size:10px">{point.key}</span><table>',
          pointFormat: '<tr><td style="color:{series.color};padding:0">{series.name}: </td>'
          + '<td style="padding:0"><b>{point.y:.2f} req/sec</b></td></tr>',
          footerFormat: '</table>',
          shared: true,
          useHTML: true
        },
        series: []
      };

      $.getJSON(src,
          function (json) {
            var rec = json[0];
            options.title.text = rec.chart_title;
            options.subtitle.text = rec.chart_subtitle;
            options.xAxis.title.text = rec.xAxis_title;
            options.yAxis.title.text = rec.yAxis_title;
            options.xAxis.categories = rec.categories;
            options.series = rec.series;

            chart = new Highcharts.Chart(options);
          });
    });
  </script>

</head>
<body>

<div id="container" style="min-width: 400px; height: 800px; margin: 0 auto"></div>

</body>
</html>